# Copyright 2025 Canonical Ltd.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: slurmctld
version: 24.11.3-2
summary: The Slurm central management daemon
description: |
  slurmctld is the central management daemon of Slurm. It monitors all other
  Slurm daemons and resources, accepts work (jobs), and allocates resources to
  those jobs. Given the critical functionality of slurmctld, there may be a
  backup server to assume these functions in the event that the primary server
  fails.

base: ubuntu@24.04
platforms:
  amd64:
package-repositories:
  - type: apt
    ppa: ubuntu-hpc/slurm-wlm-24.11

services:
  slurmctld:
    override: replace
    startup: enabled
    command: >-
      /usr/sbin/slurmctld -D
      [ -f /etc/slurm/slurm.conf -L /var/log/slurm/slurmctld.log ]
    on-failure: restart
    backoff-delay: 10s

parts:
  slurmctld:
    plugin: nil
    overlay-packages:
      - slurmctld
      - slurm-wlm-plugins
      - libpmix-dev
      - mailutils

  slurm-user:
    after:
      - slurmctld
    plugin: nil
    overlay-script: |
      mkdir -p $CRAFT_OVERLAY/var/lib/slurm/checkpoint
      mkdir -p $CRAFT_OVERLAY/run/slurmctld
      chmod -R 755 $CRAFT_OVERLAY/var/lib/slurm
      chmod -R 755 $CRAFT_OVERLAY/run/slurmctld
      chroot $CRAFT_OVERLAY chown -R slurm:slurm /var/lib/slurm
      chroot $CRAFT_OVERLAY chown -R slurm:slurm /run/slurmctld
